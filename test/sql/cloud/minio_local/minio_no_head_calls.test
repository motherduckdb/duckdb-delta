# name: test/sql/cloud/minio_local/aws_secret_chains_env.test
# description: test delta extension with a local minio installation
# group: [aws]

require httpfs

require parquet

require delta

require aws

require-env DUCKDB_MINIO_TEST_SERVER_AVAILABLE

require-env AWS_ENDPOINT

statement ok
SET secret_directory='__TEST_DIR__/aws_secret_chains_env'

# Secret with just the endpoint
statement ok
CREATE SECRET s1 (
    TYPE S3,
    ENDPOINT '${AWS_ENDPOINT}',
	USE_SSL false
);

# Log the HTTP so we can check it
statement ok
CALL duckdb_enable_logging(['HTTP']);

# single call, should be 1 GET + 0 HEAD
statement ok
FROM delta_scan('s3://test-bucket-public/dat/all_primitive_types/delta')

# Look ma, no HEAD calls!
query I
SELECT count(*)=0 
FROM duckdb_logs_parsed('HTTP') 
GROUP BY request.type 
HAVING request.type = 'HEAD';
true

# But there is at least 1 GET, so something actually happened
query I
SELECT count(*)>0 
FROM duckdb_logs_parsed('HTTP') 
GROUP BY request.type 
HAVING request.type = 'GET';
true
