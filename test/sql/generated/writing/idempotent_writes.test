# name: test/sql/generated/writing/idempotent_writes.test
# description: PoC for idempotent write API in DuckDB
# group: [writing]

require parquet

require delta

require-env GENERATED_DATA_AVAILABLE

# Copy data
statement ok
from copy_dir('data/generated/simple_table', '__TEST_DIR__/idempotent_writes/simple_table');

# Attach some delta table 
statement ok
ATTACH '__TEST_DIR__/idempotent_writes/simple_table/delta_lake' AS delta_table (TYPE delta); 

statement ok
from delta_table;

# Create a view to fetch the version
statement ok
CREATE VIEW get_app_version AS SELECT version FROM delta_get_transaction_version('delta_table', 'my_app_id');

# Version is not set yet
query I
FROM get_app_version
----
NULL

#####################################################
# Incorrect expected previous version will throw
#####################################################

statement ok
BEGIN TRANSACTION

# Mark the current delta transaction as 'my_app_id' and 'current_batch' and the expected version is latest_version
statement ok
CALL delta_set_transaction_version('delta_table', 'my_app_id', 3::UBIGINT, 2::UBIGINT);

statement ok
INSERT INTO delta_table values (1);

statement error
COMMIT
----
TransactionContext Error: Failed to commit: DeltaTransaction version for app_id 'my_app_id' did not match the expected previous version of '2' (found: 'NULL')

#####################################################
# Update the version in a transaction
#####################################################

statement ok
BEGIN TRANSACTION

# Mark the current delta transaction as 'my_app_id' and 'current_batch' and the expected version is latest_version
statement ok
CALL delta_set_transaction_version('delta_table', 'my_app_id', 1::UBIGINT, NULL::UBIGINT);

statement ok
INSERT INTO delta_table values (1); 

# Commit now needs to basically compare-and-swap on the my_app_id version: on conflicts we need to fail the commit if some other process updated the version before us
statement ok
COMMIT

# Version is not set yet
query I
FROM get_app_version
----
1

#####################################################
# Aborting a transaction will not write version
#####################################################

statement ok
BEGIN TRANSACTION

# Mark the current delta transaction as 'my_app_id' and 'current_batch' and the expected version is latest_version
statement ok
CALL delta_set_transaction_version('delta_table', 'my_app_id', 1::UBIGINT, NULL::UBIGINT);

statement ok
INSERT INTO delta_table values (1);

statement ok
ABORT

# Version is not changed
query I
FROM get_app_version
----
1

#####################################################
# Incorrect expected previous version will throw
#####################################################

statement ok
BEGIN TRANSACTION

# Mark the current delta transaction as 'my_app_id' and 'current_batch' and the expected version is latest_version
statement ok
CALL delta_set_transaction_version('delta_table', 'my_app_id', 3::UBIGINT, 2::UBIGINT);

statement ok
INSERT INTO delta_table values (1);

statement error
COMMIT
----
TransactionContext Error: Failed to commit: DeltaTransaction version for app_id 'my_app_id' did not match the expected previous version of '2' (found: '1')

# Version is not changed
query I
FROM get_app_version
----
1
